{% extends "admin/change_list.html" %}
{% load static %}

{% block content %}
<div class="dashboard-container">
    <h2>ğŸ“Š Fixly Analytics Dashboard</h2>

    <label for="categoryFilter">Filter by Category:</label>
    <select id="categoryFilter">
        <option value="all">All</option>
        {% for category in categories %}
            <option value="{{ category }}">{{ category }}</option>
        {% endfor %}
    </select>
    <button onclick="loadData()">Apply</button>

    <hr>

    <h3>ğŸ§‘ Users Overview</h3>
    <canvas id="userTypeChart" height="100"></canvas>

    <h3>ğŸ› ï¸ Bookings by Category</h3>
    <canvas id="bookingCategoryChart" height="100"></canvas>

    <h3>ğŸ‘¨â€ğŸ”§ Bookings per Provider</h3>
    <canvas id="bookingProviderChart" height="100"></canvas>

    <h3>â­ Ratings per Provider</h3>
    <canvas id="ratingProviderChart" height="100"></canvas>

    <h3>ğŸ“ Reviews by Category</h3>
    <canvas id="reviewCategoryChart" height="100"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let charts = {};

function renderChart(ctxId, labels, data, label, color='blue') {
    const ctx = document.getElementById(ctxId).getContext('2d');
    if (charts[ctxId]) charts[ctxId].destroy();

    charts[ctxId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label,
                data,
                backgroundColor: color
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false }},
            scales: { y: { beginAtZero: true } }
        }
    });
}

function loadData() {
    const category = document.getElementById('categoryFilter').value;
    fetch(`/admin/dashboard-data/?category=${category}`)
        .then(res => res.json())
        .then(data => {
            renderChart(
                "bookingCategoryChart",
                data.bookings_by_category.map(b => b.service_provider__category__category),
                data.bookings_by_category.map(b => b.count),
                "Bookings by Category",
                "purple"
            );

            renderChart(
                "bookingProviderChart",
                data.bookings_by_provider.map(p => `${p.service_provider__first_name} ${p.service_provider__last_name}`),
                data.bookings_by_provider.map(p => p.count),
                "Bookings per Provider",
                "orange"
            );

            renderChart(
                "ratingProviderChart",
                data.ratings_by_provider.map(p => `${p.service_provider__first_name} ${p.service_provider__last_name}`),
                data.ratings_by_provider.map(p => p.avg_rating),
                "Avg Ratings per Provider",
                "green"
            );

            renderChart(
                "userTypeChart",
                data.user_type_counts.map(u => u.user_type),
                data.user_type_counts.map(u => u.count),
                "Users by Type",
                "blue"
            );

            renderChart(
                "reviewCategoryChart",
                data.reviews_by_category.map(r => r.service_provider__category__category),
                data.reviews_by_category.map(r => r.count),
                "Reviews by Category",
                "teal"
            );
        });
}

document.addEventListener('DOMContentLoaded', loadData);
</script>
{% endblock %}
