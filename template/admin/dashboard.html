{% extends "admin/change_list.html" %}
{% load static %}

{% block content %}
<h2>ðŸ“Š Fixly Admin Analytics Dashboard</h2>

<div class="filters" style="margin-bottom: 20px;">
    <label>Category:</label>
    <select id="categoryFilter">
        <option value="all">All</option>
        {% for category in categories %}
            <option value="{{ category }}">{{ category }}</option>
        {% endfor %}
    </select>

    <label>Start Date:</label>
    <input type="date" id="startDate" />

    <label>End Date:</label>
    <input type="date" id="endDate" />

    <label>Search Name/Phone:</label>
    <input type="text" id="searchTerm" placeholder="Enter name or phone" />

    <button onclick="loadData()">Apply Filters</button>
</div>

<hr>

<canvas id="userTypePie" height="100"></canvas>
<canvas id="bookingLineChart" height="100"></canvas>
<canvas id="bookingProviderChart" height="100"></canvas>
<canvas id="ratingProviderChart" height="100"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let charts = {};

function renderChart(id, type, labels, data, label, color = 'blue') {
    const ctx = document.getElementById(id).getContext('2d');
    if (charts[id]) charts[id].destroy();

    charts[id] = new Chart(ctx, {
        type,
        data: {
            labels: labels,
            datasets: [{
                label,
                data,
                backgroundColor: type === 'pie' ? ['red', 'green', 'blue'] : color,
                borderColor: color,
                borderWidth: 1,
                fill: type === 'line'
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: true }},
            scales: type === 'bar' || type === 'line' ? { y: { beginAtZero: true } } : {}
        }
    });
}

function loadData() {
    const category = document.getElementById('categoryFilter').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const searchTerm = document.getElementById('searchTerm').value;

    const url = `/admin/dashboard-data/?category=${category}&start_date=${startDate}&end_date=${endDate}&search=${searchTerm}`;
    fetch(url).then(res => res.json()).then(data => {
        renderChart("userTypePie", "pie", data.user_type_counts.map(u => u.user_type), data.user_type_counts.map(u => u.count), "User Types");

        renderChart("bookingLineChart", "line", data.bookings_over_time.map(b => b.date), data.bookings_over_time.map(b => b.count), "Bookings Over Time", "purple");

        renderChart("bookingProviderChart", "bar", data.bookings_by_provider.map(p => p.name), data.bookings_by_provider.map(p => p.count), "Bookings by Provider", "orange");

        renderChart("ratingProviderChart", "bar", data.ratings_by_provider.map(p => p.name), data.ratings_by_provider.map(p => p.avg_rating), "Ratings by Provider", "green");
    });
}

document.addEventListener("DOMContentLoaded", loadData);
</script>
{% endblock %}
