{% extends "admin/base_site.html" %}
{% load static %}
{% block title %}Dashboard | {{ block.super }}{% endblock %}

{% block content %}
<h1 style="margin-bottom: 20px;">ğŸ“Š Fixly Admin Dashboard</h1>

<form method="get" style="display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; margin-bottom: 30px;">
  <div>
    <label>ğŸ“… Date Range:</label><br>
    <input type="date" name="start_date" value="{{ request.GET.start_date }}">
    <input type="date" name="end_date" value="{{ request.GET.end_date }}">
  </div>
  <div>
    <label>ğŸ” Search Provider:</label><br>
    <input type="text" name="search" value="{{ request.GET.search }}">
  </div>
  <div>
    <label>ğŸ“‚ Category:</label><br>
    <select name="category">
      <option value="all">All</option>
      {% for cat in categories %}
        <option value="{{ cat }}" {% if request.GET.category == cat %}selected{% endif %}>{{ cat }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label>ğŸ“ˆ Chart Type:</label><br>
    <select id="chartType">
      <option value="line">Line</option>
      <option value="bar">Bar</option>
      <option value="pie">Pie</option>
    </select>
  </div>
  <div>
    <button type="submit" style="padding: 6px 12px; margin-top: 5px;">Apply</button>
  </div>
</form>

<hr>

<h2>ğŸ“Œ Key Stats</h2>
<ul style="list-style-type: none; padding-left: 0;">
  <li>ğŸ‘¤ Total Users: <strong>{{ statistics.total_users }}</strong></li>
  <li>ğŸ§‘â€ğŸ”§ Total Providers: <strong>{{ statistics.total_providers }}</strong></li>
  <li>ğŸ“… Total Bookings: <strong>{{ statistics.total_bookings }}</strong></li>
  <li>â­ Average Rating: <strong>{{ statistics.average_rating }}</strong></li>
</ul>

<hr>

<h2 style="margin-top: 30px;">ğŸ“ˆ Bookings Chart</h2>
<div style="max-width: 1000px; margin-top: 20px;">
  <canvas id="bookingChart" height="120"></canvas>
</div>

<h3 style="margin-top: 40px;">ğŸ† Top 5 Providers (by Bookings)</h3>
<ul>
  {% for p in top_providers %}
    <li>{{ p.name }} - {{ p.bookings }} bookings</li>
  {% empty %}
    <li>No data available</li>
  {% endfor %}
</ul>

<h3>â­ Top 5 Rated Providers</h3>
<ul>
  {% for p in top_rated %}
    <li>{{ p.name }} - {{ p.rating }} stars</li>
  {% empty %}
    <li>No reviews yet</li>
  {% endfor %}
</ul>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block extrajs %}
<script>
  const chartData = {{ bookings_over_time|safe }};
  const chartTypeSelector = document.getElementById('chartType');
  let currentChart;

  function renderChart(type) {
    const ctx = document.getElementById('bookingChart').getContext('2d');
    const labels = chartData.map(b => b.date);
    const counts = chartData.map(b => b.count);

    if (currentChart) currentChart.destroy();

    currentChart = new Chart(ctx, {
      type: type,
      data: {
        labels: labels,
        datasets: [{
          label: 'Bookings Over Time',
          data: counts,
          backgroundColor: type === 'pie'
            ? ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b']
            : 'rgba(78, 115, 223, 0.2)',
          borderColor: '#4e73df',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: type !== 'bar',
            position: 'top'
          }
        },
        scales: type !== 'pie' ? {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        } : {}
      }
    });
  }

  chartTypeSelector.addEventListener('change', e => {
    renderChart(e.target.value);
  });

  renderChart('line');
</script>
{% endblock %}
